<html>
<head>
  <title></title>
  <link rel="icon" type="image/png" href="https://cdn.freecodecamp.org/universal/favicons/favicon-16x16.png" />
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/public/style.css">
  <style>
    code {
      background-color: whitesmoke;
    }
  </style>
</head>
<body>
<br>
<div id ='sampleposting'>
  <h2 style="text-align: left">Filters</h2>

  <form action='' id='filterForm'>

    <input id='byId' placeholder='searchById' name='id'><br>
    <input id='byName' placeholder='searchByName' name='name'><br>
    <input id='byPrice' placeholder='max price' name='price'><br>
    <label for='byQuantity'>Quantity gte 0</label>
    <input id='byQuantity' type='checkbox' placeholder='searchByQuantity' name='quantity'><br>
    <input id='page' placeholder='page' name='page' value='1'><br>
    <input id='limit' placeholder='limit' name='limit' value='5'><br>

    <input type='submit'>
  </form>

  <hr style='margin: 50px'>
<div>
  <button id='showAll'>Show all items</button>
  <button id='addNewButt'>Add new item</button>


</div>

<div id='list'>
  <table id='table'><tr><th>id</th><th>Name</th><th>Price</th><th>Quantity</th><th>Update</><Delete><th>UploadPic</th></table>
</div>
  <div id='listOfLinks'></div>


  <div id ='formFor' style="display: none"> </div>
  <div id ='uploadPic' style="display: none"></div>
  <div id ='showPic' style="display: none" class='border'></div>

<div id='info'></div>



<script src="https://code.jquery.com/jquery-2.2.1.min.js"
        integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00="
        crossorigin="anonymous"></script>
<script src="/public/client.js"></script>
<script>
  'use strict'
   
  let tbl = document.getElementById('table');
  let listOfLinks = document.getElementById('listOfLinks');
  

  $(function() {
    

  $('#filterForm').submit(function(e) {
    $('#table').text('');
    $('#formFor').attr('style', "display: none");

    $.ajax({
      url: '/api/products',
      type: 'post',
      data: $('#filterForm').serialize(),
      success: function(data) {
        $('#table').attr('style', "display: inline");
        getTbl(tbl, data.products, data.count,data.page, data.limit);
      }
    });
    e.preventDefault();
 });


     $('#showAll').click(function(e) {

      $('#formFor').attr('style', "display: none");
      removeTbl(tbl);
      $('#info').text('');

      $.ajax({
        url: '/api/products',
        type: 'get',
        success: function(data) {
          $('#table').attr('style', "display: inline");
            getTbl(tbl, data.products, data.count, 1,data.count );
        }
      });

        e.preventDefault();
  });

    $('#addNewButt').click(function() {
        newFormAddOrUpdate('formAddNew',`/api/new-item`, 'Add new item',{});
        $('#formFor').attr('style', "display: inline");
        //getAll();
  });


    $('#formUploadFile').click(function() {
        newFormAddOrUpdate('formAddNew',`/api/new-item`, 'Add new item',{});
  });

 });


function uploadFile(){
  let inElem = document.getElementById('divUploadForm');
  inElem.innerHTML = '';
}
 
async function newFormAddOrUpdate(idForm,apiWay, h1Text, objValue){

  let inElem = document.getElementById('formFor');
  inElem.innerHTML = '';
  let id = objValue.id || '';
 
  await inElem.insertAdjacentHTML('afterbegin', `
    <h1>${h1Text}</h1>
    <form  method="post"  id=${idForm} class="border">

    <input type="text" name="name" value=${objValue.name || ""} ><br>

    <input type="text" name="price" value=${objValue.price || ''} ><br>

    <input type="text" name="quantity" value=${objValue.quantity || ''}><br>
       <input type="submit" value="Submit">
        </form>
`
);

  await  $(`#${idForm}`).submit(function(e){
    e.preventDefault();
    addOrUpdate(idForm, apiWay, id);
  });
}

function addOrUpdate(idForm, apiWay, id=''){
  $('#info').text('');
  $.ajax({
    url: apiWay,
    type: 'post',
    data: $(`#${idForm}`).serialize(),
    success: function(data) {
      $('#info').text(data);
    }
  });
     $('#formFor').attr('style', "display: none");
}


async function funcDelete(e){
  let par = e.closest('tr');
  let id = par.id;
  let idOfElem = par.firstElementChild.innerHTML;
  $('#info').text('');


    await $.ajax({
      url: '/api/filter/'+idOfElem,
      type: 'delete',
      success: function(data) {
        $('#info').text(data);
      }
    });
}

async function funcUploadPic(e){
  let par = e.closest('tr');
  let id = par.firstElementChild.innerHTML;
  let url ="/api/upload/" + id; 

  let uploadPic = document.getElementById('uploadPic');
  uploadPic.insertAdjacentHTML('afterbegin', `

    <form id='formUpload' action=${url} method="post" enctype="multipart/form-data" class='border'>
      <input type="file" name="filedata" />
    <input  id=${id} value=${id} />
      <input type="submit" value="Send" />
    </form>
`)
  $('#uploadPic').attr('style', "display: inline");
  } 

async function funcUpdate(e){
  let par = e.closest('tr');
  let id = par.firstElementChild;
  let name = id.nextElementSibling;
  let price = name.nextElementSibling;
  let quantity = price.nextElementSibling;
  let apiWay = '/api/filter/'+id.innerHTML;

  let objValue = {id: id.innerHTML, name: name.innerHTML, price: price.innerHTML, quantity: quantity.innerHTML }
  newFormAddOrUpdate('formUpdate', apiWay, 'Update data', objValue )  

  await $('#formFor').attr('style', "display: inline");
} 

function removeTbl(elemTbl){
  for(let i = 0; i < elemTbl.rows.length; i++){
    while(elemTbl.rows.length > 0){
      elemTbl.deleteRow(i);
    }
  }
}

async function getTbl(elem, arr, countNum,page, limit){
   removeTbl(elem);

  let theFirstRow = "<tr><th>id</th><th>Name</th><th>Price</th><th>Quantity</th><th>Update</th><th>Delete</th><th>Upload Pic</th><th>ShowPic</th></tr>" 

  let str = arr.reduce(( item,current, index  ) => {
    let img = current.image? '../' + current.image.path : null;
    let isPic = current.image ? 'thereIsPic' : 'thereIsNoPic';
    let imgHref = current.image ? img : '';
    console.log(imgHref, 'imgHref')
    let itemId = 'itemId' + String(index);
    return item + `<tr id='${itemId}'>
      <td>${current._id}</td>
      <td>${current.name}</td>
      <td>${current.price}</td>
      <td>${current.quantity}</td>
      <td><button onclick="funcUpdate(this)">Update</button></td>
      <td><button onclick="funcDelete(this)">Delete</button></td>
      <td><button onclick="funcUploadPic(this)">UploadPic</button></td>
      <td><button onclick="showPic(this)" data-src=${imgHref}>${isPic}</button></td>
      </tr>
      `  }, '')

  let resultTbl = theFirstRow + str;

  elem.insertAdjacentHTML('beforeend', resultTbl);
  linkGenerator(listOfLinks, countNum,page, limit)
}

function showPic(e){
  $('#showPic').empty();
  let showPicElem = document.getElementById('showPic') ;
  console.log(e.dataset.src, 'this')
  showPicElem.insertAdjacentHTML('afterbegin', `
      <img src= ${e.dataset.src}>
  `)
}


function createEl(tag, par ){
	let el = document.createElement(tag);
		par.appendChild(el);
		return el;
}

function linkGenerator(elemIn,countNotes,page, limit){
  elemIn.innerHTML = '';
  let pagesCount = Math.ceil(countNotes / limit) ;
    let classVal, elemStr = '';
  for(let i = 1; i <= pagesCount; i++){
    classVal = page == i ? 'class="active pages"' : 'class="pages"';
    elemStr += `<button data-page="${i}" ${classVal} >${i}</button>` ;

  }

  elemIn.insertAdjacentHTML('afterbegin', elemStr)
 
    $('button.pages').click(async function(e) {
      await $('#page').val(e.target.dataset.page)

        $.ajax({
          url: '/api/products',
          type: 'post',
          data: $('#filterForm').serialize(),
          success: function(data) {
          $('#table').attr('style', "display: inline");
          getTbl(tbl, data.products, data.count,data.page, data.limit);
        }
      });
  });
}


</script>
</body>
</html>
